@model List<ElectronicsStore.Models.Order>
@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<div class="page-content">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-box me-2"></i>Đơn hàng của tôi</h2>
            <a href="@Url.Action("Products", "Home")" class="btn btn-primary">
                <i class="fas fa-shopping-bag me-2"></i>Tiếp tục mua sắm
            </a>
        </div>

        @if (Model.Count == 0)
        {
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-shopping-bag fa-4x text-muted"></i>
                </div>
                <h4 class="text-muted">Chưa có đơn hàng nào</h4>
                <p class="text-muted">Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm ngay!</p>
                <a href="@Url.Action("Products", "Home")" class="btn btn-primary">
                    <i class="fas fa-shopping-bag me-2"></i>Bắt đầu mua sắm
                </a>
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var order in Model)
                {
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <strong>Đơn hàng #@order.Id</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <div class="col-md-3">
                                        @switch (order.Status)
                                        {
                                            case ElectronicsStore.Models.OrderStatus.Pending:
                                                <span class="badge bg-warning">Chờ xử lý</span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Confirmed:
                                                <span class="badge bg-info">Đã xác nhận</span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Processing:
                                                <span class="badge bg-info">Đang xử lý</span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Shipped:
                                                <span class="badge bg-primary">Đã gửi</span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Delivered:
                                                <span class="badge bg-success">Đã giao</span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Completed:
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Hoàn thành
                                                </span>
                                                break;
                                            case ElectronicsStore.Models.OrderStatus.Cancelled:
                                                <span class="badge bg-danger">Đã hủy</span>
                                                break;
                                        }
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <strong class="text-success">@order.TotalAmount.ToString("N0") VNĐ</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6>Sản phẩm trong đơn hàng:</h6>
                                        @foreach (var item in order.OrderItems.Take(3))
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <img src="@(item.Product.ImageUrl ?? "https://via.placeholder.com/50x50/007bff/ffffff?text=Product")" 
                                                     class="me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@item.Product.Name">
                                                <div>
                                                    <div class="fw-medium">@item.Product.Name</div>
                                                    <small class="text-muted">Số lượng: @item.Quantity x @item.UnitPrice.ToString("N0") VNĐ</small>
                                                </div>
                                            </div>
                                        }
                                        @if (order.OrderItems.Count > 3)
                                        {
                                            <small class="text-muted">... và @(order.OrderItems.Count - 3) sản phẩm khác</small>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <strong>Địa chỉ giao hàng:</strong>
                                        </div>
                                        <div class="text-muted small">
                                            @order.ShippingAddress
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetail(@order.Id)">
                                                <i class="fas fa-eye me-1"></i>Xem chi tiết
                                            </button>
                                            @if (order.Status == ElectronicsStore.Models.OrderStatus.Pending)
                                            {
                                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="cancelOrder(@order.Id)">
                                                    <i class="fas fa-times me-1"></i>Hủy đơn
                                                </button>
                                            }
                                            @if (order.Status == ElectronicsStore.Models.OrderStatus.Delivered)
                                            {
                                                <div class="mt-2">
                                                    <button class="btn btn-success btn-sm ms-2" onclick="confirmOrderReceipt(@order.Id)">
                                                        <i class="fas fa-check-circle me-1"></i>Xác nhận đã nhận hàng
                                                    </button>
                                                    <small class="text-muted d-block mt-2 mb-2">Đơn hàng đã được giao thành công! Vui lòng xác nhận khi đã nhận hàng.</small>
                                                    @foreach (var item in order.OrderItems)
                                                    {
                                                        <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="reviewProduct(@item.ProductId, '@item.Product.Name')">
                                                            <i class="fas fa-star me-1"></i>Đánh giá "@item.Product.Name"
                                                        </button>
                                                    }
                                                </div>
                                            }
                                            @if (order.Status == ElectronicsStore.Models.OrderStatus.Completed)
                                            {
                                                <div class="mt-2">
                                                    <small class="text-success d-block mb-2">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        Đơn hàng đã hoàn thành! Cảm ơn bạn đã mua sắm.
                                                    </small>
                                                    @foreach (var item in order.OrderItems)
                                                    {
                                                        <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="reviewProduct(@item.ProductId, '@item.Product.Name')">
                                                            <i class="fas fa-star me-1"></i>Đánh giá "@item.Product.Name"
                                                        </button>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function viewOrderDetail(orderId) {
            window.location.href = '@Url.Action("OrderDetail", "Home")?id=' + orderId;
        }

        function cancelOrder(orderId) {
            if (confirm('Bạn có chắc muốn hủy đơn hàng này? Hành động này không thể hoàn tác.')) {
                $.ajax({
                    url: '@Url.Action("CancelOrder", "Home")',
                    type: 'POST',
                    data: { id: orderId },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload(); // Refresh page to show updated status
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('Có lỗi xảy ra khi hủy đơn hàng.');
                    }
                });
            }
        }

        /**
         * Confirm order receipt - Customer confirms they have received the delivered order
         * This transitions the order from "Delivered" to "Completed" status
         */
        function confirmOrderReceipt(orderId) {
            if (confirm('Bạn có chắc chắn đã nhận được hàng và muốn xác nhận hoàn thành đơn hàng này?')) {
                // Show loading state
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';

                $.ajax({
                    url: '/api/Orders/' + orderId + '/confirm-receipt',
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            alert(response.message);

                            // Refresh page to show updated status
                            location.reload();
                        } else {
                            alert(response.message);

                            // Restore button state
                            button.disabled = false;
                            button.innerHTML = originalText;
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error confirming order receipt:', error);
                        alert('Có lỗi xảy ra khi xác nhận nhận hàng. Vui lòng thử lại sau.');

                        // Restore button state
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                });
            }
        }

        function reviewProduct(productId, productName) {
            // Navigate to product detail page with a flag to show review section
            window.location.href = '@Url.Action("ProductDetail", "Home")?id=' + productId + '&review=true';
        }
    </script>
} 