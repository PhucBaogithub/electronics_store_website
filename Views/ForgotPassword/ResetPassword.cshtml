@model ElectronicsStore.Models.DTOs.ResetPasswordDTO
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="forgot-password-container">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card forgot-password-card shadow-lg border-0">
                <div class="card-header text-white text-center py-4">
                    <h3 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Đặt lại mật khẩu
                    </h3>
                    <p class="mb-0 mt-2">Nhập mã xác nhận và mật khẩu mới</p>
                </div>
                
                <div class="card-body p-4">
                    @if (ViewBag.SuccessMessage != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @ViewBag.SuccessMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        @if (ViewBag.ExpiresAt != null)
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-clock me-2"></i>
                                Mã có hiệu lực đến: <strong id="expiryTime" data-expiry="@ViewBag.ExpiresAt"></strong>
                                <div class="mt-2">
                                    <small>Thời gian còn lại: <span id="timeRemaining" class="fw-bold text-primary"></span></small>
                                </div>
                            </div>
                        }
                    }

                    <form asp-action="ResetPassword" method="post" id="resetPasswordForm">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label asp-for="Email" class="form-label fw-bold">
                                <i class="fas fa-envelope me-2"></i>Email
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-at"></i>
                                </span>
                                <input asp-for="Email" class="form-control" readonly />
                            </div>
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ResetCode" class="form-label fw-bold">
                                <i class="fas fa-key me-2"></i>Mã xác nhận
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-hashtag"></i>
                                </span>
                                <input asp-for="ResetCode" class="form-control form-control-lg text-center" 
                                       placeholder="Nhập 6 chữ số" 
                                       maxlength="6" 
                                       pattern="[0-9]{6}"
                                       autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="verifyCodeBtn">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ResetCode" class="text-danger small"></span>
                            <div id="codeVerificationResult" class="mt-2"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewPassword" class="form-label fw-bold">
                                    <i class="fas fa-lock me-2"></i>Mật khẩu mới
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-key"></i>
                                    </span>
                                    <input asp-for="NewPassword" class="form-control" 
                                           type="password" 
                                           placeholder="Ít nhất 6 ký tự" />
                                    <button type="button" class="btn btn-outline-secondary" id="toggleNewPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="NewPassword" class="text-danger small"></span>
                                <div id="passwordStrength" class="mt-2"></div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="ConfirmPassword" class="form-label fw-bold">
                                    <i class="fas fa-lock me-2"></i>Xác nhận mật khẩu
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-key"></i>
                                    </span>
                                    <input asp-for="ConfirmPassword" class="form-control" 
                                           type="password" 
                                           placeholder="Nhập lại mật khẩu" />
                                    <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                                <div id="passwordMatch" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-secondary btn-lg" id="submitBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="loadingSpinner"></span>
                                <i class="fas fa-save me-2" id="submitIcon"></i>
                                <span id="submitText">Đặt lại mật khẩu</span>
                            </button>
                            <div id="submitButtonStatus" class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Vui lòng xác minh mã và nhập mật khẩu để tiếp tục
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary w-100" id="resendCodeBtn">
                                    <i class="fas fa-redo me-2"></i>
                                    Gửi lại mã
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a asp-action="Index" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Quay lại
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="card-footer bg-light text-center py-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mật khẩu phải có ít nhất 6 ký tự và bao gồm chữ cái, số
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            let codeVerified = false;

            // Debug function
            function debugState() {
                console.log('Debug State:', {
                    codeVerified: codeVerified,
                    password: $('#NewPassword').val(),
                    confirmPassword: $('#ConfirmPassword').val(),
                    passwordLength: $('#NewPassword').val().length,
                    passwordsMatch: $('#NewPassword').val() === $('#ConfirmPassword').val(),
                    submitBtnDisabled: $('#submitBtn').prop('disabled')
                });
            }

            // Auto-focus reset code field
            $('#ResetCode').focus();

            // Format reset code input
            $('#ResetCode').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 6) value = value.substring(0, 6);
                $(this).val(value);

                if (value.length === 6) {
                    $('#verifyCodeBtn').prop('disabled', false);
                } else {
                    $('#verifyCodeBtn').prop('disabled', true);
                    codeVerified = false;
                    updateSubmitButton();
                }
                debugState();
            });
            
            // Verify reset code
            $('#verifyCodeBtn').on('click', function() {
                const code = $('#ResetCode').val();
                const email = $('#Email').val();
                
                if (code.length !== 6) {
                    showCodeResult('Mã xác nhận phải có 6 chữ số', 'danger');
                    return;
                }
                
                const btn = $(this);
                const originalHtml = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
                
                $.ajax({
                    url: '@Url.Action("VerifyCode", "ForgotPassword")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email, code: code }),
                    success: function(response) {
                        if (response.success) {
                            showCodeResult('Mã xác nhận hợp lệ!', 'success');
                            codeVerified = true;
                            $('#ResetCode').prop('readonly', true);
                            btn.html('<i class="fas fa-check"></i>').removeClass('btn-outline-secondary').addClass('btn-success');
                        } else {
                            showCodeResult(response.message, 'danger');
                            codeVerified = false;
                        }
                        updateSubmitButton();
                        debugState();
                    },
                    error: function() {
                        showCodeResult('Có lỗi xảy ra. Vui lòng thử lại.', 'danger');
                        btn.html(originalHtml).prop('disabled', false);
                        codeVerified = false;
                        updateSubmitButton();
                    }
                });
            });
            
            // Password strength checker
            $('#NewPassword').on('input keyup blur', function() {
                const password = $(this).val();
                checkPasswordStrength(password);
                checkPasswordMatch();
                updateSubmitButton();
                debugState();
            });

            $('#ConfirmPassword').on('input keyup blur', function() {
                checkPasswordMatch();
                updateSubmitButton();
                debugState();
            });
            
            // Toggle password visibility
            $('#toggleNewPassword').on('click', function() {
                togglePasswordVisibility('#NewPassword', this);
            });
            
            $('#toggleConfirmPassword').on('click', function() {
                togglePasswordVisibility('#ConfirmPassword', this);
            });
            
            // Resend code
            $('#resendCodeBtn').on('click', function() {
                const email = $('#Email').val();
                const btn = $(this);
                const originalHtml = btn.html();
                
                btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi...').prop('disabled', true);
                
                $.ajax({
                    url: '@Url.Action("ResendCode", "ForgotPassword")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email }),
                    success: function(response) {
                        if (response.success) {
                            showAlert(response.message, 'success');
                            // Reset verification state
                            codeVerified = false;
                            $('#ResetCode').prop('readonly', false).val('');
                            $('#verifyCodeBtn').html('<i class="fas fa-check"></i>').removeClass('btn-success').addClass('btn-outline-secondary');
                            updateSubmitButton();
                        } else {
                            showAlert(response.message, 'danger');
                        }
                    },
                    error: function() {
                        showAlert('Có lỗi xảy ra. Vui lòng thử lại.', 'danger');
                    },
                    complete: function() {
                        btn.html(originalHtml).prop('disabled', false);
                    }
                });
            });
            
            // Form submission
            $('#resetPasswordForm').on('submit', function(e) {
                if (!codeVerified) {
                    e.preventDefault();
                    showAlert('Vui lòng xác minh mã trước khi đặt lại mật khẩu.', 'warning');
                    return;
                }
                
                const submitBtn = $('#submitBtn');
                const submitIcon = $('#submitIcon');
                const submitText = $('#submitText');
                const loadingSpinner = $('#loadingSpinner');
                
                submitBtn.prop('disabled', true);
                submitIcon.addClass('d-none');
                loadingSpinner.removeClass('d-none');
                submitText.text('Đang xử lý...');
            });
            
            // Helper functions
            function showCodeResult(message, type) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
                
                $('#codeVerificationResult').html(`
                    <div class="alert ${alertClass} alert-sm">
                        <i class="${icon} me-2"></i>${message}
                    </div>
                `);
            }
            
            function checkPasswordStrength(password) {
                const strengthDiv = $('#passwordStrength');
                
                if (password.length === 0) {
                    strengthDiv.empty();
                    return;
                }
                
                let strength = 0;
                let feedback = [];
                
                if (password.length >= 6) strength++;
                else feedback.push('Ít nhất 6 ký tự');
                
                if (/[a-z]/.test(password)) strength++;
                else feedback.push('Chữ thường');
                
                if (/[A-Z]/.test(password)) strength++;
                else feedback.push('Chữ hoa');
                
                if (/[0-9]/.test(password)) strength++;
                else feedback.push('Số');
                
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                else feedback.push('Ký tự đặc biệt');
                
                const strengthText = ['Rất yếu', 'Yếu', 'Trung bình', 'Mạnh', 'Rất mạnh'];
                const strengthColor = ['danger', 'warning', 'info', 'success', 'success'];
                
                strengthDiv.html(`
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-${strengthColor[strength - 1]}" style="width: ${strength * 20}%"></div>
                    </div>
                    <small class="text-${strengthColor[strength - 1]}">
                        Độ mạnh: ${strengthText[strength - 1]}
                        ${feedback.length > 0 ? ' (Thiếu: ' + feedback.join(', ') + ')' : ''}
                    </small>
                `);
            }
            
            function checkPasswordMatch() {
                const password = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmPassword').val();
                const matchDiv = $('#passwordMatch');

                if (confirmPassword.length === 0) {
                    matchDiv.empty();
                    return false;
                }

                const isMatch = password === confirmPassword && password.length >= 6;

                if (isMatch) {
                    matchDiv.html('<small class="text-success"><i class="fas fa-check me-1"></i>Mật khẩu khớp</small>');
                    return true;
                } else if (password !== confirmPassword) {
                    matchDiv.html('<small class="text-danger"><i class="fas fa-times me-1"></i>Mật khẩu không khớp</small>');
                    return false;
                } else if (password.length < 6) {
                    matchDiv.html('<small class="text-warning"><i class="fas fa-exclamation me-1"></i>Mật khẩu phải có ít nhất 6 ký tự</small>');
                    return false;
                }

                return false;
            }
            
            function updateSubmitButton() {
                const password = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmPassword').val();
                const passwordLength = password.length;
                const passwordsMatch = password === confirmPassword;
                const passwordValid = passwordLength >= 6;
                const allConditionsMet = codeVerified && passwordValid && passwordsMatch && confirmPassword.length > 0;

                console.log('UpdateSubmitButton:', {
                    codeVerified: codeVerified,
                    passwordLength: passwordLength,
                    passwordValid: passwordValid,
                    passwordsMatch: passwordsMatch,
                    confirmPasswordLength: confirmPassword.length,
                    allConditionsMet: allConditionsMet
                });

                $('#submitBtn').prop('disabled', !allConditionsMet);

                // Visual feedback
                const statusDiv = $('#submitButtonStatus');
                if (allConditionsMet) {
                    $('#submitBtn').removeClass('btn-secondary').addClass('btn-success');
                    $('#submitText').text('Đặt lại mật khẩu');
                    statusDiv.html('<small class="text-success"><i class="fas fa-check-circle me-1"></i>Sẵn sàng đặt lại mật khẩu!</small>');
                } else {
                    $('#submitBtn').removeClass('btn-success').addClass('btn-secondary');

                    // Show specific status message
                    let statusMessage = '';
                    if (!codeVerified) {
                        statusMessage = '<i class="fas fa-key me-1"></i>Vui lòng xác minh mã xác nhận';
                    } else if (!passwordValid) {
                        statusMessage = '<i class="fas fa-lock me-1"></i>Mật khẩu phải có ít nhất 6 ký tự';
                    } else if (confirmPassword.length === 0) {
                        statusMessage = '<i class="fas fa-lock me-1"></i>Vui lòng xác nhận mật khẩu';
                    } else if (!passwordsMatch) {
                        statusMessage = '<i class="fas fa-exclamation-triangle me-1"></i>Mật khẩu xác nhận không khớp';
                    }

                    statusDiv.html(`<small class="text-muted">${statusMessage}</small>`);
                }
            }
            
            function togglePasswordVisibility(fieldId, button) {
                const field = $(fieldId);
                const icon = $(button).find('i');
                
                if (field.attr('type') === 'password') {
                    field.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    field.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            }
            
            function showAlert(message, type) {
                const alertClass = `alert-${type}`;
                const icon = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-exclamation-circle';
                
                const alert = $(`
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="${icon} me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                
                $('.card-body').prepend(alert);
                
                setTimeout(() => {
                    alert.alert('close');
                }, 5000);
            }
            
            // Simple countdown display
            if ($('#timeRemaining').length > 0) {
                $('#timeRemaining').text('15:00');
            }

            // Initialize button state
            updateSubmitButton();
            debugState();

            // Add manual test button for debugging
            if (window.location.search.includes('debug=1')) {
                $('body').append(`
                    <div style="position: fixed; top: 10px; right: 10px; background: #fff; border: 1px solid #ccc; padding: 10px; z-index: 9999;">
                        <h6>Debug Controls</h6>
                        <button onclick="codeVerified = true; updateSubmitButton(); debugState();" class="btn btn-sm btn-primary">Set Code Verified</button><br>
                        <button onclick="$('#NewPassword').val('123456'); $('#ConfirmPassword').val('123456'); updateSubmitButton(); debugState();" class="btn btn-sm btn-primary mt-1">Fill Passwords</button><br>
                        <button onclick="debugState();" class="btn btn-sm btn-info mt-1">Debug State</button>
                    </div>
                `);
            }
        });
    </script>
    
    <style>
        .card {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .alert-sm {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .progress {
            border-radius: 10px;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
        }
        
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
    </style>
}
